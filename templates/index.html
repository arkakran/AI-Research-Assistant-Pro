{% extends "base.html" %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="hero-title">
                <i class="fas fa-microscope"></i>
                AI Research Assistant Pro
            </h1>
            <p class="hero-subtitle">
                Advanced Multi-Agent Research System powered by LLaMA-3.3-70B and Tavily AI Search
            </p>
        </div>

        <!-- Feature Cards -->
        <div class="row g-4 mb-5">
            <div class="col-md-6 col-lg-3">
                <div class="feature-card h-100">
                    <div class="feature-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h5 class="feature-title">LLaMA-3.3-70B</h5>
                    <p class="feature-desc">Advanced language model for intelligent analysis and report generation</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="feature-card h-100">
                    <div class="feature-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h5 class="feature-title">Tavily AI Search</h5>
                    <p class="feature-desc">AI-optimized search engine for comprehensive data retrieval</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="feature-card h-100">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5 class="feature-title">Multi-Agent Analysis</h5>
                    <p class="feature-desc">Research, summarize, critique, and write with specialized AI agents</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="feature-card h-100">
                    <div class="feature-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <h5 class="feature-title">Professional Export</h5>
                    <p class="feature-desc">Download reports in PDF and Markdown with proper formatting</p>
                </div>
            </div>
        </div>

        <!-- Research Form -->
        <div class="research-section">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="research-card">
                        <h3 class="research-title">
                            <i class="fas fa-target me-2"></i>
                            Start Your Research
                        </h3>
                        
                        <form id="researchForm">
                            <div class="mb-4">
                                <label for="query" class="form-label fw-semibold">Research Query</label>
                                <textarea 
                                    class="form-control form-control-lg" 
                                    id="query" 
                                    name="query" 
                                    rows="4" 
                                    placeholder="Enter your research question here...&#10;&#10;• Top 5 AI startups in Indian Healthcare&#10;• Latest fintech trends in Southeast Asia&#10;• Renewable energy investments in Europe 2025"
                                    required
                                ></textarea>
                                <div class="form-text">
                                    Be specific about your research topic. Include industry, region, or timeframe for better results.
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="startResearchBtn">
                                <i class="fas fa-rocket me-2"></i>
                                Start Advanced Research
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section (Hidden by default) -->
        <div id="progressSection" class="progress-section" style="display: none;">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="progress-card">
                        <h4 class="progress-title">
                            <i class="fas fa-cogs me-2"></i>
                            Research Pipeline Active
                        </h4>
                        
                        <div class="progress-container mb-4">
                            <div class="progress-bar-custom">
                                <div id="progressBar" class="progress-fill"></div>
                            </div>
                            <div id="progressText" class="progress-text mt-2">
                                Initializing...
                            </div>
                        </div>
                        
                        <div id="progressMessage" class="progress-message">
                            Preparing AI Research Agents...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorSection" class="alert alert-danger mt-4" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorMessage"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Research Assistant JavaScript loaded');

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing research form');
    
    const form = document.getElementById('researchForm');
    const progressSection = document.getElementById('progressSection');
    const errorSection = document.getElementById('errorSection');
    const startBtn = document.getElementById('startResearchBtn');
    
    if (!form) {
        console.error('Research form not found!');
        return;
    }
    
    console.log('Form found, adding event listener');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('=== Form submitted ===');
        
        const queryInput = document.getElementById('query');
        if (!queryInput) {
            console.error('Query input not found!');
            return;
        }
        
        const query = queryInput.value.trim();
        console.log('Query:', query);
        
        if (!query) {
            showError('Please enter a research query');
            return;
        }
        
        // Show progress section
        if (progressSection) {
            progressSection.style.display = 'block';
        }
        if (errorSection) {
            errorSection.style.display = 'none';
        }
        
        // Update button state
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting Research...';
        
        try {
            console.log('=== Sending POST request to /start_research ===');
            
            const requestData = { query: query };
            console.log('Request data:', requestData);
            
            // Start research
            const response = await fetch('/start_research', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`Server error: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            
            const researchId = data.research_id;
            console.log('Research ID:', researchId);
            
            // Poll for progress
            pollProgress(researchId);
            
        } catch (error) {
            console.error('=== Error in form submission ===');
            console.error('Error:', error);
            showError('Error: ' + error.message);
            resetForm();
        }
    });
    
    async function pollProgress(researchId) {
        console.log('Polling progress for:', researchId);
        
        try {
            const response = await fetch(`/research_progress/${researchId}`);
            const data = await response.json();
            
            console.log('Progress data:', data);
            
            // Update progress
            updateProgress(data.progress || 0, data.message || 'Processing...');
            
            if (data.status === 'completed') {
                console.log('Research completed, redirecting...');
                // Redirect to results
                window.location.href = `/research_result/${researchId}`;
            } else if (data.status === 'error') {
                console.error('Research error:', data.error);
                showError(data.error || 'Research failed');
                resetForm();
            } else {
                // Continue polling
                setTimeout(() => pollProgress(researchId), 2000);
            }
            
        } catch (error) {
            console.error('Progress polling error:', error);
            showError('Failed to check progress: ' + error.message);
            resetForm();
        }
    }
    
    function updateProgress(progress, message) {
        console.log(`Progress: ${progress}%, Message: ${message}`);
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressMessage = document.getElementById('progressMessage');
        
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }
        if (progressText) {
            progressText.textContent = progress + '%';
        }
        if (progressMessage) {
            progressMessage.textContent = message;
        }
    }
    
    function showError(message) {
        console.error('Showing error:', message);
        
        const errorSection = document.getElementById('errorSection');
        const errorMessage = document.getElementById('errorMessage');
        
        if (errorSection && errorMessage) {
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
        } else {
            alert('Error: ' + message);
        }
    }
    
    function resetForm() {
        if (progressSection) {
            progressSection.style.display = 'none';
        }
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Start Advanced Research';
    }
    
    console.log('Event listeners attached successfully');
});

// Test function for debugging
window.testPost = function() {
    console.log('Testing POST request...');
    fetch('/test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({test: 'hello from main page'})
    })
    .then(r => r.json())
    .then(d => console.log('Test response:', d))
    .catch(e => console.error('Test error:', e));
};
</script>
{% endblock %}
